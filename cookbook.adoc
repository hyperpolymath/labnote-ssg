// SPDX-License-Identifier: MIT OR AGPL-3.0-or-later
// SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
= labnote-ssg Cookbook
:toc: macro
:toclevels: 3
:source-highlighter: rouge
:icons: font

Comprehensive recipes for working with labnote-ssg adapters.

toc::[]

== Quick Reference

=== Just Commands

[source,bash]
----
just              # Show all commands
just check        # Check all adapters
just test         # Run tests
just test-e2e     # Run e2e tests
just test-all     # Run all tests
just lint         # Lint code
just fmt          # Format code
just security     # Security checks
just adapters     # List all adapters
just ci           # Run CI checks
----

=== Must Commands

[source,bash]
----
must build        # Build all
must test         # Run tests
must test-e2e     # E2E tests
must lint         # Lint code
must security     # Security audit
must docs         # Generate docs
must ci           # CI pipeline
----

== CLI Recipes

[[cli]]
=== Adapter Operations

==== List All Adapters

[source,bash]
----
# Using just
just adapters

# Direct command
ls -1 adapters/*.js | xargs -n1 basename | sed 's/.js$//'

# With count
ls adapters/*.js | wc -l  # 28
----

==== Test Adapter Connection

[source,bash]
----
# Using just
just adapter-test zola

# Direct Deno command
deno eval --allow-run \
  "import * as a from './adapters/zola.js'; \
   console.log(await a.connect() ? '✓ Connected' : '✗ Failed');"
----

==== Get Adapter Information

[source,bash]
----
# Using just
just adapter-info mdbook

# Show all tools for an adapter
deno eval "import * as a from './adapters/mdbook.js'; \
  console.log('Name:', a.name); \
  console.log('Language:', a.language); \
  console.log('Tools:', a.tools.map(t => t.name));"
----

==== Run Adapter Tool

[source,bash]
----
# Example: Get Zola version
deno eval --allow-run \
  "import * as a from './adapters/zola.js'; \
   await a.connect(); \
   const result = await a.tools.find(t => t.name === 'zola_version').execute({}); \
   console.log(result.stdout);"
----

=== Testing Commands

==== Run All Tests

[source,bash]
----
# Using just
just test-all

# Or separately
just test && just test-e2e

# Direct Deno
deno test --allow-run --allow-read tests/
deno test --allow-run --allow-read --allow-write tests/e2e/
----

==== Test with Coverage

[source,bash]
----
just test-cov

# Or manually
deno test --allow-run --allow-read --coverage=coverage/ tests/
deno coverage coverage/
deno coverage --lcov coverage/ > coverage.lcov
----

==== Test Single Adapter

[source,bash]
----
deno test --allow-run tests/adapters/zola_test.js
----

=== Security Commands

==== Full Security Audit

[source,bash]
----
# Using just
just security

# Check for dangerous patterns
grep -rn 'eval\|exec\|shell' adapters/

# Verify no hardcoded secrets
grep -rn 'password\|secret\|api.key' adapters/
----

==== Verify Command Execution Safety

[source,bash]
----
# All adapters should use Deno.Command with array args
grep -l 'Deno.Command' adapters/*.js | wc -l  # Should be 28

# No shell string execution
grep -l 'shell:' adapters/*.js | wc -l  # Should be 0
----

=== Documentation Commands

==== Generate HTML Docs

[source,bash]
----
just docs-serve

# Or manually
asciidoctor README.adoc -o docs/index.html
asciidoctor cookbook.adoc -o docs/cookbook.html
----

==== View Documentation

[source,bash]
----
# Start local server
python3 -m http.server 8000 --directory docs/

# Or use Deno
deno run --allow-net --allow-read https://deno.land/std/http/file_server.ts docs/
----

== Just Recipes

[[just]]
=== Build & Development

[source,justfile]
----
# Check syntax of all adapters
check:
    deno check adapters/*.js

# Format all JavaScript files
fmt:
    deno fmt adapters/

# Lint all code
lint:
    deno lint adapters/

# Run all verification
verify: fmt-check lint check
----

=== Testing Recipes

[source,justfile]
----
# Unit tests
test:
    deno test --allow-run --allow-read tests/

# E2E tests
test-e2e:
    deno test --allow-run --allow-read --allow-write tests/e2e/

# All tests with coverage
test-cov:
    deno test --allow-run --allow-read --coverage=coverage/ tests/
    deno coverage coverage/
----

=== Adapter Recipes

[source,justfile]
----
# List adapters
adapters:
    @ls -1 adapters/*.js | xargs -n1 basename | sed 's/.js$//'

# Test specific adapter
adapter-test name:
    deno eval --allow-run "import * as a from './adapters/{{name}}.js'; \
      console.log(await a.connect() ? '✓' : '✗');"

# Get adapter info
adapter-info name:
    deno eval "import * as a from './adapters/{{name}}.js'; \
      console.log(JSON.stringify({name: a.name, lang: a.language, tools: a.tools.length}, null, 2));"
----

=== Release Recipes

[source,justfile]
----
# Prepare release
release-prep version:
    @sed -i 's/version . "[^"]*"/version . "{{version}}"/' STATE.scm
    @echo "Updated to {{version}}"

# Tag and push
release-tag version:
    git tag v{{version}}
    git push --tags
----

== Nickel Formulae

[[nickel]]
=== Adapter Configuration Schema

[source,nickel]
----
# adapters.ncl - Adapter configuration schema

let AdapterSchema = {
  name | String,
  language | String,
  description | String,
  binary_path | String,
  tools | Array { name | String, description | String },
}

let adapters = {
  zola = {
    name = "Zola",
    language = "Rust",
    description = "Fast static site generator",
    binary_path = "zola",
    tools = [
      { name = "zola_init", description = "Initialize site" },
      { name = "zola_build", description = "Build site" },
      { name = "zola_serve", description = "Dev server" },
    ],
  },

  mdbook = {
    name = "mdBook",
    language = "Rust",
    description = "Book from Markdown",
    binary_path = "mdbook",
    tools = [
      { name = "mdbook_init", description = "Initialize book" },
      { name = "mdbook_build", description = "Build book" },
      { name = "mdbook_serve", description = "Dev server" },
    ],
  },
}

in adapters
----

=== CI Configuration Schema

[source,nickel]
----
# ci.ncl - CI pipeline configuration

let CIConfig = {
  deno_version | String | default = "v1.40",
  node_version | String | default = "20",

  checks = {
    lint | Bool | default = true,
    fmt | Bool | default = true,
    test | Bool | default = true,
    security | Bool | default = true,
  },

  triggers = {
    push_branches | Array String | default = ["main"],
    pr_branches | Array String | default = ["main"],
  },
}

let config : CIConfig = {
  deno_version = "v1.40",
  checks.security = true,
}

in config
----

=== Project Metadata Schema

[source,nickel]
----
# project.ncl - Project metadata

let Project = {
  name = "labnote-ssg",
  version = "0.3.0",

  adapters = {
    count = 28,
    languages = [
      "Rust", "Elixir", "Haskell", "Clojure",
      "Common Lisp", "Racket", "Julia", "Scala",
      "F#", "OCaml", "Nim", "D", "Ada", "Erlang"
    ],
  },

  compliance = {
    rsr = "gold",
    spdx = true,
    sha_pinned = true,
  },
}

in Project
----

== CLI Combinatorics

[[combinatorics]]
=== Command Permutations

==== Development Workflow

[source,bash]
----
# Full development check
just fmt && just lint && just check && just test

# Or combined
just verify && just test

# Quick check before commit
just pre-commit
----

==== CI Simulation

[source,bash]
----
# Simulate full CI locally
just ci

# Equivalent to:
just verify && just test && just security
----

==== Adapter Testing Matrix

[source,bash]
----
# Test all Rust adapters
for adapter in zola mdbook cobalt; do
  just adapter-test $adapter
done

# Test all adapters
for f in adapters/*.js; do
  name=$(basename "$f" .js)
  echo "Testing: $name"
  just adapter-test "$name"
done
----

=== Command Concatenations

==== Build + Test + Security

[source,bash]
----
just check && just test-all && just security
----

==== Format + Lint + Commit

[source,bash]
----
just fmt && just lint && git add -A && git commit -m "chore: format and lint"
----

==== Full Release Pipeline

[source,bash]
----
# Version bump + test + tag + push
VERSION="0.4.0"
just release-prep $VERSION && \
just test-all && \
git add -A && \
git commit -m "chore(release): v$VERSION" && \
git tag "v$VERSION" && \
git push --tags
----

=== Environment Combinations

==== With Specific Deno Version

[source,bash]
----
# Using asdf
asdf install deno 1.40.0
asdf local deno 1.40.0
just test
----

==== In Container

[source,bash]
----
# Using Podman
podman run --rm -v $(pwd):/app -w /app denoland/deno:1.40.0 \
  deno test --allow-run --allow-read tests/
----

== Hooks Configuration

[[hooks]]
=== Git Hooks

==== Pre-commit Hook

[source,bash]
----
#!/bin/bash
# .githooks/pre-commit
set -e

echo "Running pre-commit checks..."

# Format check
deno fmt --check adapters/

# Lint
deno lint adapters/

echo "✓ Pre-commit checks passed"
----

==== Pre-push Hook

[source,bash]
----
#!/bin/bash
# .githooks/pre-push
set -e

echo "Running pre-push checks..."

# Full verification
just verify

# Run tests
just test

echo "✓ Pre-push checks passed"
----

==== Commit-msg Hook

[source,bash]
----
#!/bin/bash
# .githooks/commit-msg
# Enforce conventional commits

commit_msg=$(cat "$1")
pattern="^(feat|fix|docs|style|refactor|test|chore|security)(\(.+\))?: .+"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
  echo "ERROR: Commit message does not follow conventional commits format"
  echo "Expected: type(scope): description"
  echo "Types: feat, fix, docs, style, refactor, test, chore, security"
  exit 1
fi
----

=== Enable Git Hooks

[source,bash]
----
# Configure git to use hooks directory
git config core.hooksPath .githooks

# Make hooks executable
chmod +x .githooks/*
----

== Troubleshooting

=== Common Issues

==== Deno Not Found

[source,bash]
----
# Install via asdf
asdf plugin add deno
asdf install deno latest
asdf global deno latest

# Or direct install
curl -fsSL https://deno.land/install.sh | sh
----

==== Adapter Connection Fails

[source,bash]
----
# Check if binary is installed
which zola || echo "Zola not installed"

# Check binary version
zola --version

# Verify Deno permissions
deno eval --allow-run "console.log('Permissions OK')"
----

==== Tests Fail with Permission Error

[source,bash]
----
# Ensure correct permissions
deno test --allow-run --allow-read --allow-write tests/

# Or use allow-all for debugging (not recommended for production)
deno test --allow-all tests/
----

== Reference

=== Adapter Interface

[source,javascript]
----
// Standard adapter exports
export const name = "SSGName";
export const language = "Language";
export const description = "Description";

export async function connect() { /* ... */ }
export async function disconnect() { /* ... */ }
export function isConnected() { /* ... */ }

export const tools = [
  {
    name: "ssg_action",
    description: "What this tool does",
    inputSchema: { /* JSON Schema */ },
    execute: async (params) => { /* ... */ }
  }
];
----

=== Command Result Schema

[source,javascript]
----
// Standard command result
{
  success: boolean,  // true if exit code 0
  stdout: string,    // captured stdout
  stderr: string,    // captured stderr
  code: number       // exit code
}
----
